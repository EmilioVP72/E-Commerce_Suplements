RUTAS API
api/Driver

<?php

use App\Http\Controllers\Web\Driver\DriverController;
use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| API Routes Driver
|--------------------------------------------------------------------------
|*/
// Revisión - Permisos
Route::prefix('drivers/v2')->middleware(['auth'])->group(function () {
    Route::get('/all', [DriverController::class,'index'])->middleware('can:get-drivers');
    Route::get('/regular', [DriverController::class,'getRegular'])->middleware('can:get-drivers-regular');
    Route::get('/Ejecutivo', [DriverController::class,'getEjecutivo'])->middleware('can:get-drivers-ejecutivo');
    Route::get('/Turistico', [DriverController::class,'getTuristico'])->middleware('can:get-drivers-turistico');
    Route::get('/OneDriver/{id}', [DriverController::class,'getOneDriver'])->middleware('can:get-drivers-onedriver');
    Route::get('/Map', [DriverController::class, 'getMap'])->middleware('can:get-drivers-map');
    Route::post('/StoreDriver', [DriverController::class,'Store'])->middleware('can:get-drivers-store');
    Route::put('/UpdateDriver/{id}', [DriverController::class,'Update'])->middleware('can:get-drivers-update');

});

CONTROLADOR
app/Http/Controllers/Driver

<?php

namespace App\Http\Controllers\Driver;


use App\Http\Controllers\Controller;
use App\Driver;
use App\User;
use App\Http\Resources\Web\Driver\DriverResource;
use App\Http\Requests\Web\Driver\DriverRequest;
use App\Traits\UtilResponse;
use App\Repositories\Web\DriverRepository;

class DriverController extends Controller
{
    private $utilResponse;
    private $driverRepository;
    public function __construct(UtilResponse $utilResponse, DriverRepository $driverRepository)
    {
        $this->utilResponse = $utilResponse;
        $this->driverRepository = $driverRepository;
    }
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        return $this->utilResponse->succesResponse(DriverResource::collection($this->driverRepository->getByLocations()), 'Drivers obtenidos correctamente');
    }

    public function getRegular()
    {
        $drivers = $this->driverRepository->getByType(1);
        if (count($drivers) > 0) {
            return $this->utilResponse->succesResponse(DriverResource::collection($drivers), 'Todos los Drivers cargados');
        }
        return $this->utilResponse->errorResponse('Drivers no Encontrados');
    }

    public function getEjecutivo()
    {
        $drivers = $this->driverRepository->getByType(2);
        if (count($drivers) > 0) {
            return $this->utilResponse->succesResponse(DriverResource::collection($drivers), 'Todos los Drivers cargados');
        }
        return $this->utilResponse->errorResponse('Drivers no Encontrados');
    }
    public function getTuristico()
    {
        $drivers = $this->driverRepository->getByType(3);
        if (count($drivers) > 0) {
            return $this->utilResponse->succesResponse(DriverResource::collection($drivers), 'Todos los Drivers cargados');
        }
        return $this->utilResponse->errorResponse('Drivers no Encontrados');
    }

    public function getOneDriver($id)
    {
        $driver = $this->driverRepository->getOne($id);
        if ($driver) {
            return $this->utilResponse->succesResponse(new DriverResource($driver), 'Driver Encontrado');
        }
        return $this->utilResponse->errorResponse('No existe el driver');
    }

    public function getMap()
    {
        return $this->utilResponse->succesResponse(DriverResource::collection($this->driverRepository->getByLocations()), 'Drivers obtenidos correctamente');
    }

    //PENDIENTE: verificar el vehiculo
    public function Store(DriverRequest $request)
    {
        if (Driver::where('canceled', false)->count() >= env('LIMITADO')) {
            return "Alcanzó el límite de conductores en su plan de servicio.";
        }
        $driver = $this->driverRepository->store($request);
        if ($driver) {
            return $this->utilResponse->succesResponse(new DriverResource($driver), 'Driver creado correctamente');
        }
        return $this->utilResponse->errorResponse('Error al crear el driver');
    }

    //PENDIENTE: verificar el vehiculo
    public function Update($id, DriverRequest $request)
    {
        $driver = $this->driverRepository->getOne($id);
        if ($driver) {
            $user = $driver->user;
            if ($user) {
                $vehicle = $driver->vehicle;
                if ($vehicle) {
                    $driverUpdate = $this->driverRepository->update($driver, $request, $user);
                    if ($driverUpdate) {
                    return $this->utilResponse->succesResponse(new DriverResource($driver), 'Driver actualizado correctamente');
                }
                return $this->utilResponse->errorResponse('Error al actualizar el driver');
                }
                return $this->utilResponse->errorResponse('Vehiculo no Encontrado');  
            }
            return $this->utilResponse->errorResponse('Usuario no encontrado');
        }
        return $this->utilResponse->errorResponse('No existe el Driver');
    }
}


REPOSITORIO
app/Http/Repositories/Driver

<?php

namespace App\Repositories;

use App\Driver;
use App\Http\Requests\Web\Driver\DriverRequest;
use App\User;
use App\Role;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class DriverRepository
{
    protected $driver;
    protected $user;
    protected $role;

    public function __construct(Driver $driver, User $user, Role $role)
    {
        $this->driver = $driver;
        $this->user = $user;
        $this->role = $role;
    }

    /**
     * Método para obtener los driver 
     * @param mixed $locations
     * @return Driver[]|\Illuminate\Database\Eloquent\Collection
     */
    public function getByLocations()
    {
        return $this->driver::where('canceled', false)->get();
    }

    public function getByType($type)
    {
        return $this->driver::where('canceled', false)
            ->where('flag_active', 1)
            ->where('flag_service', 0)
            ->whereHas('vehicle', function ($query) use ($type) {
                $query->where('id_type', $type);
            })
            ->get();
    }

    public function getOne($id)
    {
        if(is_numeric($id)) {
            return $this->driver::with('user')->where('id', $id)->first();
        }
        return false;
    }

    public function store(Request $request)
    {
        $user = new $this->user;
        $user->fill($request->all());
        $user->password=md5($request->email);
        $user->id_role = $this->role->where('name', 'Driver')->firstOrFail()->id;
        DB::beginTransaction();
        try {
            $user->save();
            $driver = new $this->driver;
            $driver->fill($request->all()); 
            $driver->id_user = $user->id;
            if ($request->hasFile('image')) {
                $image = $request->file('image');
                $driver->image = $image->store('drivers', 'public');
            } else {
                $driver->image = 'https://confortpremier.alio.cloud/storage/operadores/driver.no.disponible@aliomexico.com.jpg';
            }
            $driver->save();
            DB::commit();
            return $driver;
        } catch (\Exception $e) {
            DB::rollBack();
            return false;
        }
    }

    public function update($driver, $request, $user)
    {
        DB::beginTransaction();
        try {
            $user->fill($request->all());
            if ($request->filled('password')) {
                $user->password = md5($request->password);
            }
            if ($request->has('status')) {
                $user->status = (bool) $request->status;
            }
            $user->save();
            $driver->fill($request->all());
            if ($request->hasFile('image')) {
                $image = $request->file('image');
                $driver->image = $image->store('drivers', 'public');
            }
            
            $flag = true;
            $driver->flag_documents = 1;
            if ($flag && $driver->expiration_license < date('Y-m-d')) {
                $flag = false;
            }
            if ($flag && $driver->expiration_policy < date('Y-m-d')) {
                $flag = false;
            }
            if ($flag && $driver->expiration_magazine < date('Y-m-d')) {
                $flag = false;
            }
            if ($flag && $driver->expiration_card < date('Y-m-d')) {
                $flag = false;
            }
            if ($flag) {
                $driver->flag_documents = 0;
            }

            $driver->update();
            DB::commit();
            return $driver;
        } catch (\Exception $e) {
            DB::rollBack();
            return false;
        }   
    }
}

REQUEST
app/http/Requests/Driver

<?php

namespace App\Http\Requests\Driver;

use Illuminate\Foundation\Http\FormRequest;

class DriverRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     *
     * @return bool
     */
    public function authorize()
    {
        return true;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array
     */
    
    public function rules()
    {
        switch($this->method()){
            case 'POST':
                return [
                    'name' => 'required|string|max:255',
                    'email' => 'required|string|email|max:255|unique:users',
                    'phone' => 'required|nullable|unique:users',
                    'id_vehicle' => 'integer',
                    'latitude' => 'numeric',
                    'longitude' => 'numeric',
                    'device' => 'nullable|string',
                    'license' => 'required|string',
                    'card' => 'required|string',
                    'expiration_card' => 'required|date',
                    'expiration_license' => 'required|date',
                    'policy' => 'required|string',
                    'magazine' => 'required|string',
                    'expiration_policy' => 'required|date',
                    'expiration_magazine' => 'required|date',
                    'image' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
                ];
            
                case 'PUT':
                    return [
                        'name' => 'string|max:255',
                        'email' => 'string|email|max:255',
                        'phone' => 'nullable|unique:users',
                        'id_vehicle' => 'integer',
                        'latitude' => 'numeric',
                        'longitude' => 'numeric',
                        'device' => 'string',
                        'license' => 'string',
                        'card' => 'string',
                        'expiration_card' => 'date',
                        'expiration_license' => 'date',
                        'policy' => 'string',
                        'magazine' => 'string',
                        'expiration_policy' => 'date',
                        'expiration_magazine' => 'date',
                        'image' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
                    ];
                
                default:
                    return [];
        }
    }

    public function messages()
    {
        return [
            'name.required' => 'El nombre es obligatorio.',
            'name.string' => 'El nombre debe ser una cadena de texto.',
            'name.max' => 'El nombre debe ser máximo de 255 caracteres.',

            'email.required' => 'El correo electrónico es obligatorio.',
            'email.email' => 'El correo electrónico debe ser válido.',
            'email.max' => 'El correo electrónico debe ser máximo de 255 caracteres.',
            'email.unique' => 'El correo electrónico ya está registrado.',

            'phone.unique' => 'El teléfono ya está registrado.',
            
            'id_vehicle.integer' => 'El ID del vehículo debe ser un número entero.',

            'latitude.numeric' => 'La latitud debe ser un valor numérico.',

            'longitude.numeric' => 'La longitud debe ser un valor numérico.',

            'license.required' => 'La licencia es obligatoria.',

            'card.required' => 'La tarjeta es obligatoria.',

            'expiration_card.required' => 'La fecha de vencimiento de la tarjeta es obligatoria.',
            'expiration_card.date' => 'La fecha de vencimiento de la tarjeta debe ser una fecha válida.',

            'expiration_license.required' => 'La fecha de vencimiento de la licencia es obligatoria.',
            'expiration_license.date' => 'La fecha de vencimiento de la licencia debe ser una fecha válida.',

            'policy.required' => 'La póliza es obligatoria.',

            'magazine.required' => 'La revista es obligatoria.',

            'expiration_policy.required' => 'La fecha de vencimiento de la póliza es obligatoria.',
            'expiration_policy.date' => 'La fecha de vencimiento de la póliza debe ser una fecha válida.',

            'expiration_magazine.required' => 'La fecha de vencimiento de la revista es obligatoria.',
            'expiration_magazine.date' => 'La fecha de vencimiento de la revista debe ser una fecha válida.',

            'image.image' => 'El archivo debe ser una imagen.',
            'image.mimes' => 'La imagen debe ser de tipo: jpeg, png, jpg.',
            'image.max' => 'La imagen no debe superar los 2048 kb.',
        ];
    }

}

RESOURCE
app/Http/Resources/Driver

<?php

namespace App\Http\Resources;

use Illuminate\Http\Resources\Json\JsonResource;
use Illuminate\Support\Facades\Storage;
use App\Vehicle;

class DriverResource extends JsonResource
{
    /**
     * Transform the resource into an array.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return array
     */
    public function toArray($request)
    {
        return [
            'id'                => $this->id,
            'id_user'           => $this->id_user,
            'latitude'          => $this->latitude,
            'longitude'         => $this->longitude,
            'device'            => $this->device,
            'license'           => $this->license,
            'card'              => $this->card,
            'policy'=> $this->policy,
            'magazine'=> $this->magazine,
            'expiration_card'   => $this->expiration_card,
            'expiration_license'=> $this->expiration_license,
            'expiration_policy'=> $this->expiration_policy,
            'expiration_magazine'=> $this->expiration_magazine,
            'flag_status'       => $this->flag_status,
            'flag_active'       => $this->flag_active,
            'flag_service'      => $this->flag_service,
            'flag_panic'        => $this->flag_panic,
            'id_vehicle'        => $this->id_vehicle,
            'image'             => Storage::url('operadores/driver.no.disponible@aliomexico.com.jpg'),
            'name'              => $this->name,
            'email'             => $this->email,
            'phone'             => $this->phone,
            'id_role'           => $this->id_role,
            'status'            => $this->status,
            'role'              => $this->role,
            'vehicle'            => new VehicleResource(Vehicle::find($this->id_vehicle)),
            'bearing'           => $this->bearing ?? '',
        ];       
    }
}


